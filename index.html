<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/star-rating-svg.css">
    <style>
        body {
            display: grid;
            grid-template-columns: 70% 30%;
            grid-template-areas: "content controls";
        }

        @media (min-width: 750px) {
            body {
                grid-template-columns: 25% 50% 25%;
                grid-template-areas: ". content controls";
            }
        }

        #container {
            grid-area: content;
            display: grid;
            justify-items: center;
        }

        #controls {
            grid-area: controls;
        }

        h3 {
            margin-top: 0px;
            margin-bottom: 10px;
        }

        h4 {
            margin-top: 0px;
            margin-bottom: 5px;
        }

        #container>.detail,
        #container>h3 {
            justify-self: left;
        }

        .detail {
            width: 100%;
        }

        .detail:hover {
            border-color: gray;
            border-width: 1px;
            border-style: dashed;
        }

        input,
        textarea {
            display: none;
        }

        .remove {
            float: right;
            display: none;
        }

        .detail:hover .remove {
            display: block;
        }

        p:empty::after, h1:empty::after, h3:empty::after {
            content: 'Add text here';
            color: lightgrey;
        }
    </style>

    <title>Rating Builder</title>
</head>

<body>
    <div id="container">
        <h1>Title</h1>
        <input value="" />
        <div class="rating"></div>
        <p></p>
        <textarea></textarea>
        <h3>Detailbewertung:</h3>
    </div>
    <div id="controls">
        <h1>Controls</h1>
        <button type="button" id="add" class="btn btn-primary">Add Rating</button>
        <button type="button" id="url" class="btn btn-success">Generate URL</button>
    </div>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script src="js/jquery.star-rating-svg.min.js"></script>
    <script type="text/javascript" src="js/json-url.js"></script>
    <script>
        const lib = JsonUrl('lzma'); // JsonUrl is added to the window object

        const load = () => {
            const arr = window.location.href.split('?data=');

            if (arr.length < 2) {
                $(".rating").starRating({
                    starSize: 25,
                    hoverColor: '#FFED85',
                    activeColor: '#FFD700',
                    ratedColor: '#FFD700',
                    disableAfterRate: false,
                });
                return;
            }

            lib.decompress(arr[1]).then(json => {
                $('#container h1').html(json.title);
                $('#container input').val(json.title);
                $('#container .rating').data('rating', json.rating);
                $('#container p').html(json.text);
                $('#container textarea').val(json.text);

                json.details.forEach(d => {
                    $('#container').append(`
                    <div class="detail">
                        <button class="remove">remove</button>
                        <h4>${d.title.replace(/\n/g,"<br />")}</h4>
                        <input value="${d.title}"/>
                        <div class="rating" data-rating="${d.rating}"></div>
                        <p>${d.text.replace(/\n/g,"<br />")}</p>
                        <textarea>${d.text}</textarea>
                    </div>
                `);
                });

                $(".rating").starRating({
                    starSize: 25,
                    hoverColor: '#FFED85',
                    activeColor: '#FFD700',
                    ratedColor: '#FFD700',
                    disableAfterRate: false,
                });

                $('.rating').each(function () {
                    const rating = $(this).data('rating');

                    $(this).starRating('setRating', rating);
                });
            });
        }

        $(document).ready(function () {
            load();
        });

        function moveText() {
            $(this).prev().html($(this).val().replace(/\n/g,"<br />"));
            $(this).hide();
            $(this).prev().show();
            $(this).off('blur', moveText);
        }

        $(document).on('click', 'p, h1, h4', function () {
            $(this).hide();
            $(this).next().show().focus().on('blur', moveText);
        });

        $(document).on('click', '.remove', function () {
            $(this).parents('.detail').remove();
        });

        $('#add').on('click', function () {
            $('#container').append(`
                <div class="detail">
                    <button class="remove">remove</button>
                    <h4>Title</h4>
                    <input value=""/>
                    <div class="rating"></div>
                    <p></p>
                    <textarea></textarea>
                </div>
            `);

            $(".rating").last().starRating({
                starSize: 25,
                hoverColor: '#FFED85',
                activeColor: '#FFD700',
                ratedColor: '#FFD700',
                disableAfterRate: false,
            });
        });

        $('#url').on('click', function () {
            const json = {
                title: $('#container > input').val(),
                rating: $('#container > .rating').starRating('getRating'),
                text: $('#container > textarea').val(),
                details: []
            }

            $('.detail').each(function() {
                json.details.push({
                    title: $(this).find('input').val(),
                    rating: $(this).find('.rating').starRating('getRating'),
                    text: $(this).find('textarea').val()
                });
            });

            lib.compress(json).then(output => {
                const url = 'file:///home/robin/Documents/01_Code/Javascript/RatingBuilder/index.html';
                alert(url + '?data=' + output);
            });
        });
    </script>
</body>

</html>